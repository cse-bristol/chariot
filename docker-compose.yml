version: '2'
services:
    influx:
        image: influxdb:alpine

    db:
        image: postgres:alpine
        environment:
            POSTGRES_DB: chariot
            POSTGRES_USER: chariot
            POSTGRES_PASSWORD: chariot

    app:
        build: src/app
        links:
            - db
            - influx
        volumes:
            - ./src/app:/app
            - /media
            - /static

    web:
        restart: always
        image: nginx:alpine
        ports:
            - "80:80"
            - "443:443"
        links:
            - app
        volumes:
            - ./src/conf/nginx${CONF_TAG}.conf:/etc/nginx/nginx.conf:ro
            - ./cert/certs:/cert
            - ./src/www:/www
        volumes_from:
            - app

    cert:
        build: src/cert
        links:
            - web
        volumes:
            - ./cert/certs:/etc/nginx/certs
            - ./cert:/etc/letsencrypt
            - ./src/www:/var/www
        environment:
            - CERTS_PATH=/etc/nginx/certs
            - DOMAINS
            - CHECK_FREQ=10